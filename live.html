<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Go Live - REAL Streaming</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #020617;
  color: white;
  text-align: center;
}
header {
  background: #0f172a;
  padding: 15px;
}
.box {
  padding: 20px;
}
input, button {
  width: 90%;
  padding: 12px;
  margin-top: 12px;
  border-radius: 6px;
  border: none;
}
button {
  font-weight: bold;
  cursor: pointer;
}
.go { background: #22c55e; }
.stop { background: #ef4444; color: white; }
video {
  width: 90%;
  margin-top: 15px;
  border-radius: 10px;
  display: none;
  background: black;
}
</style>
</head>

<body>

<header>
  <h2>ðŸ”´ Go Live (Real Streaming)</h2>
</header>

<div class="box">
  <input id="game" placeholder="Game name (e.g PUBG, CODM)">
  <button class="go" onclick="goLive()">Go Live</button>
  <button class="stop" onclick="endLive()">End Live</button>

  <video id="preview" autoplay muted></video>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  setDoc,
  doc,
  getDoc,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ðŸ”¥ Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyC7krl12Xewrb3nEYzWGCEeQE0s5FgG10U",
  authDomain: "gamelive-3db71.firebaseapp.com",
  projectId: "gamelive-3db71",
  storageBucket: "gamelive-3db71.firebasestorage.app",
  messagingSenderId: "581788962069",
  appId: "1:581788962069:web:619583602ee846e17a6d1c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const video = document.getElementById("preview");
const gameInput = document.getElementById("game");

let pc = null;
let localStream = null;
let streamDocId = null;
let currentUser = null;
let username = "Unknown";

const iceConfig = {
  iceServers: [{ urls: "stun:stun.l.google.com:19302" }]
};

/* ðŸ” AUTH STATE */
onAuthStateChanged(auth, async (user) => {
  if (!user) {
    location.href = "index.html";
    return;
  }

  currentUser = user;

  const snap = await getDoc(doc(db, "users", user.uid));
  if (snap.exists()) {
    username = snap.data().username;
  }
});

/* ðŸ”´ START LIVE */
window.goLive = async () => {

  if (!auth.currentUser) {
    Swal.fire("Auth Error", "Please login again", "error");
    return;
  }

  const gameName = gameInput.value.trim();
  if (!gameName) {
    Swal.fire("Missing Game Name", "Enter game name", "warning");
    return;
  }

  if (streamDocId) {
    Swal.fire("Already Live", "You are already streaming", "info");
    return;
  }

  try {
    /* Capture screen */
    localStream = await navigator.mediaDevices.getDisplayMedia({
      video: true,
      audio: true
    });

    video.srcObject = localStream;
    video.style.display = "block";

    /* Create stream doc */
    const streamRef = await addDoc(collection(db, "streams"), {
      userId: auth.currentUser.uid,
      username,
      game: gameName,
      live: true,
      featured: false,
      startedAt: serverTimestamp()
    });

    streamDocId = streamRef.id;

    /* WebRTC */
    pc = new RTCPeerConnection(iceConfig);

    localStream.getTracks().forEach(track =>
      pc.addTrack(track, localStream)
    );

    pc.onicecandidate = (e) => {
      if (e.candidate) {
        addDoc(
          collection(db, "streams", streamDocId, "ice"),
          e.candidate.toJSON()
        );
      }
    };

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);

    await setDoc(
      doc(db, "streams", streamDocId, "signal", "offer"),
      { type: offer.type, sdp: offer.sdp }
    );

    Swal.fire("LIVE!", "Streaming started successfully", "success");

  } catch (err) {
    console.error(err);
    Swal.fire("Error", err.message, "error");
  }
};

/* â›” END LIVE */
window.endLive = async () => {

  if (localStream) {
    localStream.getTracks().forEach(t => t.stop());
    localStream = null;
    video.srcObject = null;
    video.style.display = "none";
  }

  if (pc) {
    pc.close();
    pc = null;
  }

  if (streamDocId) {
    await setDoc(
      doc(db, "streams", streamDocId),
      { live: false, endedAt: serverTimestamp() },
      { merge: true }
    );
    streamDocId = null;
  }

  Swal.fire("Live Ended", "Your stream has been stopped", "info");
};
</script>

</body>
</html>
