<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GameLive - Dashboard</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    background: #020617;
    color: white;
  }

  header {
    background: #0f172a;
    padding: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  header h2 { color: #22c55e; margin:0; }

  .nav-links a {
    color: #cbd5f5;
    margin-left: 15px;
    text-decoration: none;
    font-weight: bold;
  }
  .nav-links a:hover { color: #22c55e; }

  .logout {
    background: #f87171;
    color: black;
    padding: 8px 14px;
    border: none;
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    margin-left: 10px;
  }

  .container { padding: 20px; }

  .card { background: #0f172a; padding: 15px; border-radius: 10px; margin-bottom: 15px; }
  .card h3 { margin-top:0; color:#38bdf8; }

  .streams { display: grid; gap: 15px; }
  .stream {
    background: #020617;
    padding: 15px;
    border-radius: 8px;
    border-left: 4px solid #22c55e;
  }
  .featured { border-left: 4px solid #facc15; background:#1e293b; }

  .stream h4 { margin:0; color:#22c55e; }
  .stream p { margin:5px 0; color:#cbd5f5; }

  .watch, .report {
    margin-top: 8px;
    width: 100%;
    padding: 8px;
    border-radius: 6px;
    border: none;
    font-weight: bold;
    cursor: pointer;
  }

  .watch { background: #38bdf8; }
  .report { background: #ef4444; color:white; }

  .empty { opacity:0.7; text-align:center; }
</style>
</head>

<body>
<header>
  <h2>üéÆ GameLive</h2>
  <div class="nav-links">
    <a href="dashboard.html">Dashboard</a>
    <a href="live.html">Go Live</a>
    <a href="profile.html">Profile</a>
    <button class="logout" onclick="logout()">Logout</button>
  </div>
</header>

<div class="container">

  <div class="card">
    <h3>Welcome</h3>
    <p id="userEmail">Loading...</p>
  </div>

  <div class="card">
    <h3>üî¥ Live Streams</h3>
    <div class="streams" id="streams">
      <p class="empty">Loading live streams...</p>
    </div>
  </div>

</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { 
  getFirestore, collection, query, where, orderBy, onSnapshot, doc, getDoc, addDoc, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC7krl12Xewrb3nEYzWGCEeQE0s5FgG10U",
  authDomain: "gamelive-3db71.firebaseapp.com",
  projectId: "gamelive-3db71",
  storageBucket: "gamelive-3db71.firebasestorage.app",
  messagingSenderId: "581788962069",
  appId: "1:581788962069:web:619583602ee846e17a6d1c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const streamsDiv = document.getElementById("streams");
const userLabel = document.getElementById("userEmail");

// üîê AUTH
onAuthStateChanged(auth, async (user) => {
  if (!user) { location.href = "index.html"; return; }
  const userDoc = await getDoc(doc(db,"users",user.uid));
  userLabel.innerText = userDoc.exists() ? `Logged in as: ${userDoc.data().username}` : "Logged in";
});

// üî¥ SAFE LIVE STREAM QUERY
function loadStreams() {
  try {
    const q = query(
      collection(db,"streams"),
      where("live","==",true),
      orderBy("featured","desc"),
      orderBy("startedAt","desc")
    );

    onSnapshot(q, snapshot => {
      streamsDiv.innerHTML = "";

      if(snapshot.empty){
        streamsDiv.innerHTML = '<p class="empty">No one is live right now üò¥</p>';
        return;
      }

      snapshot.forEach(docSnap => {
        const s = docSnap.data();
        const div = document.createElement("div");
        div.className = "stream" + (s.featured ? " featured" : "");
        div.innerHTML = `
          <h4>${s.featured ? "‚≠ê FEATURED<br>" : ""}üéÆ ${s.game}</h4>
          <p>Streamer: <b>${s.username}</b></p>
          <p>Status: üî¥ Live</p>
          <button class="watch" onclick="watchStream('${docSnap.id}')">Watch Live</button>
        `;
        streamsDiv.appendChild(div);
      });
    }, err => {
      // üîî Friendly error for missing index
      console.error("Firestore query error:", err);
      streamsDiv.innerHTML = `
        <p class="empty">Cannot load live streams. Firestore index missing.</p>
        <p style="opacity:0.6;font-size:0.85em;">
          Check console for the index creation link.
        </p>
      `;
    });
  } catch(e){
    console.error("Unexpected error loading streams:", e);
  }
}

// Call safe load function
loadStreams();

// ‚ñ∂ WATCH STREAM
window.watchStream = (id) => {
  Swal.fire({ title:"Joining Stream", text:"Connecting...", icon:"info", timer:1200, showConfirmButton:false });
  setTimeout(()=>{ location.href = "player.html?stream=" + id }, 1200);
};

// üö™ LOGOUT
window.logout = () => {
  Swal.fire({
    title: "Logout?", icon: "warning", showCancelButton: true, confirmButtonColor: "#22c55e"
  }).then(result => {
    if(result.isConfirmed){
      signOut(auth).then(()=> location.href="index.html");
    }
  });
};
</script>

</body>
</html>
