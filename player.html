<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Watch Live</title>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
body {
  margin: 0;
  font-family: Arial;
  background: #020617;
  color: white;
}
header {
  background: #0f172a;
  padding: 12px;
  text-align: center;
}
.container {
  padding: 15px;
  text-align: center;
}
video {
  width: 95%;
  max-width: 900px;
  border-radius: 10px;
  background: black;
}
.info {
  margin-top: 10px;
  opacity: 0.9;
}
.ended {
  margin-top: 40px;
  font-size: 18px;
  opacity: 0.7;
}
.back {
  margin-top: 15px;
  padding: 10px 18px;
  background: #38bdf8;
  border: none;
  border-radius: 6px;
  font-weight: bold;
  cursor: pointer;
}
</style>
</head>

<body>

<header>
  <h2>üî¥ Watch Live Stream</h2>
</header>

<div class="container">
  <video id="player" autoplay playsinline></video>

  <div class="info" id="info">Loading stream...</div>

  <div id="ended" class="ended" style="display:none">
    ‚ùå This live stream has ended
    <br><br>
    <button class="back" onclick="goBack()">‚¨Ö Back to Dashboard</button>
  </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore, doc, getDoc, collection, onSnapshot, addDoc
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî• Firebase Config */
const firebaseConfig = {
  apiKey: "AIzaSyC7krl12Xewrb3nEYzWGCEeQE0s5FgG10U",
  authDomain: "gamelive-3db71.firebaseapp.com",
  projectId: "gamelive-3db71",
  storageBucket: "gamelive-3db71.firebasestorage.app",
  messagingSenderId: "581788962069",
  appId: "1:581788962069:web:619583602ee846e17a6d1c"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const video = document.getElementById("player");
const info = document.getElementById("info");
const endedBox = document.getElementById("ended");

let pc = null;
let localStream = null;
let currentUser = null;

// ICE server config
const iceConfig = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

// Get stream ID from URL
const params = new URLSearchParams(window.location.search);
const streamId = params.get("stream");

// üîê AUTH
onAuthStateChanged(auth, async user => {
  if (!user) {
    Swal.fire("Not Authenticated","Please login","error")
      .then(()=> location.href="index.html");
    return;
  }
  currentUser = user;
  startWatching();
});

async function startWatching() {
  if (!streamId) {
    Swal.fire("Invalid Stream","No stream specified","error")
      .then(()=> location.href="dashboard.html");
    return;
  }

  const streamRef = doc(db, "streams", streamId);

  // Listen for stream doc changes
  onSnapshot(streamRef, async snap => {
    if (!snap.exists() || !snap.data().live) {
      endStream();
      return;
    }

    const s = snap.data();
    info.innerHTML = `
      üéÆ <b>${s.game}</b><br>
      Streamer: <b>${s.username}</b><br>
      Status: üî¥ Live
    `;

    // Start WebRTC connection only once
    if (!pc) {
      pc = new RTCPeerConnection(iceConfig);

      // Receive remote tracks
      pc.ontrack = e => {
        video.srcObject = e.streams[0];
      };

      // Load ICE candidates
      const iceCol = collection(db, "streams", streamId, "ice");
      onSnapshot(iceCol, snapIce => {
        snapIce.docChanges().forEach(change => {
          if (change.type === "added") {
            const candidate = change.doc.data();
            if (candidate) pc.addIceCandidate(candidate).catch(console.warn);
          }
        });
      });

      // Get offer from Firestore
      const offerDoc = doc(db, "streams", streamId, "signal", "offer");
      const offerSnap = await getDoc(offerDoc);
      if (!offerSnap.exists()) { console.warn("No offer found"); return; }

      await pc.setRemoteDescription(offerSnap.data());

      // Create answer
      const answer = await pc.createAnswer();
      await pc.setLocalDescription(answer);

      // Send answer back
      await addDoc(collection(db, "streams", streamId, "signal"), {
        type: answer.type,
        sdp: answer.sdp
      });
    }
  });
}

// ‚ùå End Stream
function endStream() {
  if (pc) { pc.close(); pc = null; }
  video.pause();
  video.style.display = "none";
  info.style.display = "none";
  endedBox.style.display = "block";
}

// ‚¨Ö Back
window.goBack = () => { location.href="dashboard.html"; };
</script>

</body>
</html>
